<!DOCTYPE html>
<html lang="es" style="background:#0e0f1b;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
<title>Triggui â€” Abre un libro fÃ­sico. AquÃ­ y ahora.</title>

<style>
  html, body { background:#0e0f1b !important; color:#fff; margin:0; padding:0; height:100%; font-family:'Archivo',sans-serif; -webkit-overflow-scrolling:touch; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
  #tarjetaCard { overflow-wrap: break-word; word-break: break-word; box-sizing: border-box; }
</style>

<meta property="og:title" content="Abre. Un Libro. FÃ­sico.">
<meta property="og:description" content="Toma un libro fÃ­sico que tengas cerca, Ã¡brelo en cualquier parte, lee la primera lÃ­nea que veas.">
<meta property="og:image" content="https://triggui.com/imagotipo.png">
<meta property="og:url" content="https://triggui.com">
<meta property="og:type" content="website">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-CLK554FCNM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-CLK554FCNM');
</script>

<script>
// ========================================
// ðŸ§  LOGICA DE DATOS
// ========================================
function saveLocal(key, value) { try { localStorage.setItem('triggui_' + key, JSON.stringify(value)); } catch(e) {} }
function getLocal(key, defaultValue = null) { try { const data = localStorage.getItem('triggui_' + key); return data ? JSON.parse(data) : defaultValue; } catch(e) { return defaultValue; } }

// Reset Helper
window.reset = function() {
  localStorage.removeItem('triggui_books_opened');
  localStorage.removeItem('triggui_concepts');
  localStorage.removeItem('triggui_last_book_time');
  localStorage.removeItem('triggui_streak');
  localStorage.removeItem('triggui_last_visit');
  console.log('âœ… Reset completo. Recarga la pÃ¡gina.');
}

// Variables
let tapCount = 0;
let tapTimer = null;
let cardOpenedThisSession = false; 

// Tracking
function track(event, data = {}) {
  if (typeof gtag !== 'undefined') gtag('event', event, { event_category: 'app_engagement', ...data });
}

// Streak
function updateStreak() {
  const today = new Date().toDateString();
  const lastVisit = getLocal('last_visit');
  let streak = getLocal('streak', 0);

  if (streak === 0) {
    streak = 1;
    saveLocal('streak', 1);
    saveLocal('last_visit', today);
    return 1;
  }

  if (lastVisit === today) return streak;

  const yesterday = new Date(Date.now() - 86400000).toDateString();
  const newStreak = (lastVisit === yesterday) ? streak + 1 : 1;
  
  saveLocal('streak', newStreak);
  saveLocal('last_visit', today);
  track('streak_updated', { streak: newStreak });
  return newStreak;
}

function incrementBooks() {
  const count = getLocal('books_opened', 0) + 1;
  saveLocal('books_opened', count);
  saveLocal('last_book_time', Date.now());
  track('book_opened', { total: count });
  return count;
}

// LÃ“GICA DE CONCEPTOS (+4 y +1)
function addConcepts(amount) {
  let current = getLocal('concepts', 0);
  const books = getLocal('books_opened', 0);
  if (current === 0 && books > 1) { current = books * 5; } // MigraciÃ³n
  const newVal = current + amount;
  saveLocal('concepts', newVal);
  return newVal;
}

// Rewards
const surprises = [
  { type: 'rare', msg: 'âœ¨ Libro raro descubierto', chance: 0.12 },
  { type: 'streak', msg: 'ðŸ”¥ Racha activa', chance: 0.18 },
  { type: 'milestone', msg: 'ðŸŽ¯ Gran descubrimiento', chance: 0.08 },
  { type: 'none', msg: '', chance: 0.62 }
];
function getRandomSurprise() {
  const rand = Math.random();
  let cumulative = 0;
  for (const s of surprises) {
    cumulative += s.chance;
    if (rand <= cumulative) return s;
  }
  return surprises[surprises.length - 1];
}

// Social Proof
function getRealisticUserCount() {
  const base = 28;
  const variance = Math.floor(Math.random() * 8);
  return base + variance;
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;700&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ========================================
   ðŸŽ¨ ESTILOS UI
   ======================================== */
.intro{
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  padding:2rem 2.4rem; background:rgba(20,24,38,.78); border-radius:28px;
  z-index:120; font-family:'Poppins',sans-serif; text-align:center;
  box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  font-size:clamp(1.1rem,3.8vw,1.9rem); font-weight:700; line-height:1.25;
  opacity:0; transform:translate(-50%,-52%) scale(.985);
  animation:introIn .6s ease-out .15s forwards, introHide 3.2s 1.7s forwards; 
}
.intro .t{ background:linear-gradient(120deg,#c9fff2,#30ffe4 40%,#9dd5ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
@keyframes introIn{ to{opacity:1; transform:translate(-50%,-50%) scale(1)} }
@keyframes introHide{ to{opacity:0; visibility:hidden; transform:translate(-50%,-80%) scale(.985)} }

/* Grid */
.grid{position:absolute;inset:5vh 1.5vw;display:grid;gap:1vw}
@media(orientation:landscape){.grid{grid-template-columns:repeat(4,1fr)}}
@media(orientation:portrait){.grid{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr)}}

.block{
  position:relative; display:flex; align-items:center; justify-content:center;
  padding:1rem; border-radius:22px; font-weight:700; cursor:pointer;
  background-size:320% 320%;
  transition:background-position 4s linear, transform .15s ease, filter .2s ease;
  overflow:hidden; isolation:isolate;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.28);
}
.block:hover{ background-position:100% 100%; filter:saturate(1.05) contrast(1.02); }
.block:active{ transform:scale(.97); }
.block::before{ content:"";position:absolute;inset:0;border-radius:inherit; background:linear-gradient(180deg,rgba(255,255,255,.14),transparent 62%); mix-blend-mode:soft-light;pointer-events:none; }

.label, .frase { z-index:2; text-align:center; transition:opacity .25s, transform .25s; }
.label { opacity:1; transform:translateY(0); font-size:clamp(1rem, 3vw, 1.6rem); font-weight:700; line-height:1.3; letter-spacing:0.3px; }
.frase { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:1rem; opacity:0; transform:translateY(6px); font-size:clamp(0.95rem, 2.8vw, 1.4rem); font-weight:600; }
.block.show .label { opacity:0; transform:translateY(-6px); }
.block.show .frase { opacity:1; transform:translateY(0); }

/* Portada */
.portada{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; padding:1rem; animation:pop .6s ease-out forwards; max-height:90%; }
@keyframes pop{ 0%{transform:scale(.8);opacity:0} 100%{transform:scale(1);opacity:1} }
.portada img{ max-width:94%; max-height:76%; border-radius:18px; box-shadow:0 12px 32px rgba(0,0,0,.55); }
.port-text h2{ font-size:clamp(2rem,6vw,3.5rem); font-weight:800; text-shadow:0 2px 6px rgba(0,0,0,.35); text-align:center;}
.port-text p{ font-size:clamp(1.2rem,4vw,1.8rem); font-weight:600; opacity:.9; }
.emoji-big{ font-size:clamp(1.6rem,5vw,2.8rem); filter:drop-shadow(0 4px 8px rgba(0,0,0,.3)); }

/* CTA */
.cta{ position:fixed; bottom:3vh; left:50%; transform:translateX(-50%); z-index:100; display:none; gap:.9rem; justify-content:center; }
.cta button{
  width:clamp(3.5rem,min(8vw,8vh),4.5rem); height:clamp(3.5rem,min(8vw,8vh),4.5rem);
  border:none; border-radius:50%; display:flex; align-items:center; justify-content:center;
  font-size:clamp(1.5rem,3.5vw,2rem); cursor:pointer; background-size:200% 200%;
  box-shadow: 0 4px 12px rgba(0,0,0,.3); backdrop-filter:blur(8px);
}
#otro{ background:linear-gradient(135deg,#5fbfff,#1e90ff); color:#fff; }
#fisico{ background:linear-gradient(135deg,#b2f8c8,#42d97c); color:#000; }
#share{ background:linear-gradient(135deg,#ff8a00,#ff3d3d); color:#fff; }

/* Overlay */
#tarjetaOverlay { display:none; position:fixed; inset:0; z-index:999; align-items:center; justify-content:center; background: radial-gradient(circle, rgba(0,0,0,0.90), rgba(0,0,0,0.98)); backdrop-filter: blur(5px); }
#tarjetaCard { width:min(420px, 90vw); height:600px; opacity:0; transform:scale(0.92); animation:cardIn 0.45s ease-out forwards; border-radius:20px; }
body.webview #tarjetaCard { height:650px !important; }
@keyframes cardIn { to { opacity:1; transform:scale(1); } }

/* âœ¨ BADGE COMPACTO NIVEL DIOS (CENTRADO POR MARGENES - NO SE MUEVE) */
#progressBadge {
  position: fixed;
  top: 15px;
  /* Centrado absoluto sin transform X */
  left: 0; 
  right: 0; 
  margin: 0 auto;
  
  width: fit-content;
  max-width: 90%; /* Evita desborde en mÃ³vil */
  
  z-index: 150;
  background: rgba(20,24,38,0.90); border: 1px solid rgba(255,255,255,0.12);
  padding: 6px 20px; /* Compacto verticalmente */
  border-radius: 99px; color: #dfe9ff;
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  
  /* AnimaciÃ³n SOLO Vertical */
  opacity: 0; 
  animation: badgeDrop 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  
  box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center;
  cursor: pointer; user-select: none;
  pointer-events: auto;
}

@keyframes badgeDrop {
  0% { opacity: 0; transform: translateY(-40px); }
  100% { opacity: 1; transform: translateY(0); }
}

#progressBadge .line1 {
  display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px; 
  opacity: 0.65; margin-bottom: 2px; font-weight: 700; color: #a0aec0;
}
#progressBadge .line2 {
  display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap;
  font-size: 13px; font-weight: 700; color: #fff; line-height: 1.2;
}
#progressBadge .dot { width: 3px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 50%; display: inline-block; margin: 0 2px; }
.highlight-txt { color: #30ffe4; text-shadow: 0 0 10px rgba(48,255,228,0.25); }

/* Toast */
#toast {
  position: fixed; top: 90px; left: 50%; transform: translateX(-50%) translateY(-20px); z-index: 160;
  background: rgba(20,24,38,0.95); border: 1px solid rgba(255,255,255,0.1);
  padding: 12px 24px; border-radius: 16px; font-size: 15px; color: #fff;
  backdrop-filter: blur(12px); font-weight: 600; opacity: 0; pointer-events: none;
  transition: all 0.3s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.4); text-align: center; max-width: 80%;
}
#toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Modal Unificado */
#appModal { display: none; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s ease; }
#appModal.visible { display: flex; opacity: 1; }
.modal-glass {
  background: linear-gradient(145deg, rgba(30,34,50,0.98), rgba(10,12,20,0.99));
  border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 28px; width: 88%; max-width: 380px;
  text-align: center; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 20px 50px rgba(0,0,0,0.7);
}
#appModal.visible .modal-glass { transform: scale(1); }
.m-emoji { font-size: 46px; margin-bottom: 14px; display: block; animation: bounce 1s infinite; }
@keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-10px);} }
.m-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; color: #fff; letter-spacing: 0.2px; }
.m-text { font-size: 16px; color: #b0b5c0; line-height: 1.5; margin-bottom: 22px; }
.m-highlight { color: #30ffe4; font-weight: 600; display: block; margin-top: 4px; font-size: 14px; }
.m-buttons { display: flex; flex-direction: column; gap: 10px; }
.m-btn { padding: 14px; border-radius: 14px; font-size: 16px; font-weight: 700; border: none; cursor: pointer; transition: transform 0.1s; text-decoration: none; display: flex; align-items: center; justify-content: center; }
.m-btn:active { transform: scale(0.98); }
.btn-primary { background: linear-gradient(135deg, #ff0080, #7928ca); color: white; box-shadow: 0 4px 15px rgba(255,0,128,0.3); }
.btn-secondary { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); }

/* CelebraciÃ³n */
.cele{ position:fixed; inset:0; background:rgba(0,0,0,.88); display:none; align-items:center; justify-content:center; z-index:110; flex-direction: column; }
.cele-msg{ font-family:'Poppins'; font-size:2rem; text-align:center; background:rgba(255,255,255,.05); padding:2rem 3rem; border-radius:20px; }
.num{ color:#30ffe4; font-weight:900; font-size:2.8rem; }

@media (max-width: 480px) {
  #progressBadge { padding: 6px 14px; top: 12px; }
  #progressBadge .line2 { font-size: 11px; gap: 4px; } /* Texto ligeramente menor en mÃ³vil para asegurar 1 linea */
  .grid { gap: 1vw; } 
  .cele-msg { font-size: 1.5rem; padding: 1.5rem 2rem; }
}
</style>
</head>
<body>

<div id="progressBadge">
  <span class="line1">Tu avance acumulado</span>
  <span class="line2" id="badgeContent">Cargando...</span>
</div>

<div id="appModal">
  <div class="modal-glass">
    <span class="m-emoji" id="mEmoji">ðŸ‘‹</span>
    <div class="m-title" id="mTitle">TÃ­tulo</div>
    <div class="m-text" id="mText">Texto</div>
    <div class="m-buttons">
      <button id="mBtnPrimary" class="m-btn btn-primary">Aceptar</button>
      <button id="mBtnSecondary" class="m-btn btn-secondary">Cancelar</button>
    </div>
  </div>
</div>

<div id="toast"></div>
<div class="intro" id="intro"></div>
<div class="grid" id="grid"></div>
<div class="cta" id="cta">
  <button id="otro"><span class="icon">ðŸŽ²</span></button>
  <button id="fisico"><span class="icon">ðŸ”Ÿ</span></button>
  <button id="share"><span class="icon">ðŸ“–</span></button>
</div>
<div id="tarjetaOverlay"><div id="tarjetaCard"></div></div>
<div class="cele" id="cele"><div class="cele-msg" id="celeMsg"></div></div>

<script>
// ========================================
// SISTEMA MODAL
// ========================================
const Modal = {
  el: document.getElementById('appModal'),
  emoji: document.getElementById('mEmoji'),
  title: document.getElementById('mTitle'),
  text: document.getElementById('mText'),
  pBtn: document.getElementById('mBtnPrimary'),
  sBtn: document.getElementById('mBtnSecondary'),
  
  show: function(config) {
    this.emoji.innerText = config.emoji || 'âœ¨';
    this.title.innerText = config.title || 'Triggui';
    this.text.innerHTML = config.text || '';
    this.pBtn.innerText = config.btnText || 'Continuar';
    this.pBtn.onclick = null; this.sBtn.onclick = null;

    this.pBtn.onclick = () => {
      this.close();
      if(config.onConfirm) config.onConfirm();
    };
    
    if(config.showCancel) {
      this.sBtn.style.display = 'flex';
      this.sBtn.innerText = config.cancelText || 'Cerrar';
      this.sBtn.onclick = () => {
        this.close();
        if(config.onCancel) config.onCancel();
      };
    } else {
      this.sBtn.style.display = 'none';
    }

    this.el.style.display = 'flex';
    setTimeout(() => this.el.classList.add('visible'), 10);
  },
  
  close: function() {
    this.el.classList.remove('visible');
    setTimeout(() => { this.el.style.display = 'none'; }, 300);
  }
};

// ========================================
// LOGICA APP
// ========================================
const grid=document.getElementById("grid"), cta=document.getElementById("cta"),
      btnOtro=document.getElementById("otro"), btnLibro=document.getElementById("fisico"), btnShare=document.getElementById("share"),
      cele=document.getElementById("cele"), celeMsg=document.getElementById("celeMsg"),
      progressBadge=document.getElementById("progressBadge"), toast=document.getElementById("toast");

let libro=null, revealed=false;
const portIdx=Math.floor(Math.random()*4),
      emojis=["ðŸŒŠ","ðŸ›¡ï¸","ðŸ§ ","âœ¨","ðŸ“˜","ðŸ”®","â¤ï¸","ðŸªž"];
const isURL = s => /^https?:\/\//i.test(s || "");
const ANG = [115,205,35,320];
const grad = i => `linear-gradient(${ANG[i%4]}deg,${libro.colores[i]},${libro.colores[(i+1)%4]})`;

// INTRO
const frasesIntro = ["Â¿QuÃ© sientes y quÃ© buscas ahora?", "Â¿QuÃ© sientes y quÃ© buscas ahora?", "Â¿QuÃ© sientes y quÃ© buscas ahora?"];
document.getElementById("intro").innerHTML=`<span class="t">${frasesIntro[Math.floor(Math.random()*frasesIntro.length)]}</span>`;

// === TRIPLE TAP RESET ===
progressBadge.addEventListener('click', () => {
  tapCount++;
  if (tapCount === 1) tapTimer = setTimeout(() => { tapCount = 0; }, 800);
  if (tapCount === 3) {
    clearTimeout(tapTimer); tapCount = 0;
    Modal.show({
      emoji: 'ðŸ”„', title: 'Â¿Reiniciar Contadores?', text: 'Esto pondrÃ¡ tus estadÃ­sticas a cero para reiniciar la experiencia.',
      btnText: 'SÃ­, Reiniciar', showCancel: true, cancelText: 'Cancelar',
      onConfirm: () => {
        window.reset();
        location.reload();
      }
    });
  }
});

function showToast(msg, duration=3000) {
  toast.textContent = msg; toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), duration);
}

// âœ¨ UPDATE BADGE (Conceptos)
function updateBadge() {
  const streak = updateStreak(); 
  const books = getLocal('books_opened', 0);
  const concepts = getLocal('concepts', books * 5); 
  
  document.getElementById('badgeContent').innerHTML = 
    `ðŸ”¥ ${streak}d <span class="dot"></span> ðŸ“š ${books} libros <span class="dot"></span> <span class="highlight-txt">ðŸ¤“ ${concepts} conceptos absorbidos - Â¡AplÃ­calos hoy!</span>`;
}

// BUILDERS
function adjustScale(wrap){
  const parent=wrap.closest(".portada"); if(!parent)return;
  const avail=parent.clientHeight-40; let scale=1;
  wrap.style.transform="scale(1)";
  while(wrap.scrollHeight>avail&&scale>0.55){ scale-=.02; wrap.style.transform=`scale(${scale})`; }
}

function buildPort(i){
  const d=document.createElement("div"); d.className="portada";
  const wrap=document.createElement("div"); wrap.className="port-text-wrap";
  const box=document.createElement("div"); box.className="port-text";
  box.innerHTML=`<h2>${libro.titulo}</h2><p>${libro.autor}</p>`;
  const emoji=document.createElement("div"); emoji.className="emoji-big";
  emoji.textContent=emojis[i%emojis.length];
  wrap.append(box,emoji);
  if(isURL(libro.portada)){ d.append(Object.assign(new Image(),{src:libro.portada,loading:"lazy"})); }
  else{ d.append(wrap); setTimeout(()=>adjustScale(wrap),0); }
  d.addEventListener("click", e => { e.stopPropagation(); btnShare.click(); });
  return d;
}

function render(){
  grid.innerHTML="";
  for(let i=0;i<4;i++){
    const card=document.createElement("div"); card.className="block"; card.style.background=grad(i);
    const label=document.createElement("div"); label.className="label";
    label.textContent=`${emojis[i%emojis.length]} ${libro.palabras[i]}`;
    label.style.color=libro.textColors?.[i]||"#fff";
    const frase=document.createElement("div"); frase.className="frase";
    frase.textContent=libro.frases[i]; frase.style.color=libro.textColors?.[i]||"#fff";
    const port=buildPort(i);

    if(i===portIdx){
      card.append(port, label, frase);
      card.onclick = e => {
        if(!revealed){
          label.style.display="none"; port.style.display="flex"; port.classList.add("reveal-pulse");
          [...grid.children].forEach((c,j)=>j!==portIdx&&c.classList.add("show"));
          cta.style.display="flex"; revealed=true;
          const c = libro.colores;
          document.getElementById("otro").style.background = `linear-gradient(135deg, ${c[0]}, ${c[1]})`;
          document.getElementById("fisico").style.background = `linear-gradient(135deg, ${c[1]}, ${c[2]})`;
          document.getElementById("share").style.background = `linear-gradient(135deg, ${c[2]}, ${c[3]})`;
          document.getElementById("otro").style.color = pickTextColor(c[0]);
          document.getElementById("fisico").style.color = pickTextColor(c[1]);
          document.getElementById("share").style.color = pickTextColor(c[2]);
          handleBookReveal();
        } else { e.stopPropagation(); btnShare.click(); }
      };
    } else {
      card.append(label, frase);
      card.onclick = () => { if(revealed) location.reload(); else card.classList.toggle("show"); };
    }
    grid.append(card);
  }
}

// LOGICA ENGAGEMENT
function handleBookReveal() {
  const booksCount = incrementBooks();
  addConcepts(4); 
  updateBadge();
  fetch("https://triggui-api.vercel.app/api/increment", {cache:"no-store"}).catch(()=>{});

  const delay = 1500;
  const userCount = getRealisticUserCount();

  if (booksCount === 2) {
    setTimeout(() => Modal.show({
      emoji: 'ðŸ“¬', title: 'Â¡2 Libros!', text: 'Â¿Te gustarÃ­a recibir estas joyas por WhatsApp cada lunes?',
      btnText: 'Ver cÃ³mo funciona', onConfirm: () => window.open('https://triggui.com/#planes', '_blank'),
      showCancel: true, cancelText: 'Seguir explorando'
    }), delay);
  } else if (booksCount === 5) {
    setTimeout(() => Modal.show({
      emoji: 'ðŸŽ¯', title: '5 Libros Descubiertos', text: 'Recibe pÃ¡ginas seleccionadas para tu momento exacto.<br><span class="m-highlight">Precio lanzamiento: $100/mes</span>',
      btnText: 'Quiero recibirlos', onConfirm: () => window.open('https://triggui.com/#planes', '_blank'),
      showCancel: true
    }), delay);
  } else if (booksCount === 10) {
    setTimeout(() => Modal.show({
      emoji: 'ðŸ”¥', title: 'Â¡EstÃ¡s en racha!', text: `Ya llevas <b>10 libros</b> y <b>50 conceptos absorbidos</b>. ${userCount} personas estÃ¡n aplicando esto hoy. <br>Ãšnete al grupo de WhatsApp.`,
      btnText: 'Suscribirme', onConfirm: () => window.open('https://triggui.com/#planes', '_blank'),
      showCancel: true
    }), delay);
  } else if ([15, 20, 30, 50, 75, 100].includes(booksCount)) {
    setTimeout(() => Modal.show({
      emoji: 'ðŸ§ ', title: `${booksCount} Libros Descubiertos`, text: 'Tu mente se estÃ¡ expandiendo. No pierdas el ritmo.<br><span class="m-highlight">Asegura tu precio de por vida hoy.</span>',
      btnText: 'Ver planes', onConfirm: () => window.open('https://triggui.com/#planes', '_blank'),
      showCancel: true
    }), delay);
  }
}

// HANDLERS
btnOtro.onclick = () => { location.reload(); track('reload_clicked'); };
btnLibro.onclick = async() => {
  btnLibro.disabled=true; cele.style.display="flex"; celeMsg.innerHTML='<span class="num">...</span><br>libros abiertos juntos';
  try{ const r=await fetch("https://triggui-api.vercel.app/api/increment"); const d=await r.json(); celeMsg.innerHTML=`âœ¨ <span class="num">${d.total.toLocaleString("es-MX")}</span><br>libros abiertos juntos`; track('physical_book_opened', { total: d.total }); }catch{}
  setTimeout(()=>{ cele.style.display="none"; btnLibro.disabled=false; },2300);
};

function luminance(hex) { try { const c = hex.replace("#","").match(/.{1,2}/g).map(x=>parseInt(x,16)/255); const f = v => v<=.03928 ? v/12.92 : Math.pow((v+.055)/1.055,2.4); return 0.2126*f(c[0])+0.7152*f(c[1])+0.0722*f(c[2]); } catch { return 0; } }
function pickTextColor(bg) { try { return luminance(bg) > 0.35 ? "#000" : "#fff"; } catch { return "#fff"; } }

// SHARE & TARJETA
btnShare.onclick = () => {
  const t = libro.tarjeta; const card = document.getElementById("tarjetaCard");
  
  // +1 Concepto
  if (!cardOpenedThisSession) {
    addConcepts(1);
    updateBadge(); 
    cardOpenedThisSession = true;
  }

  const safePaper = t.style.paper||"#111"; const safeInk = t.style.ink||pickTextColor(safePaper); const safeBorder=t.style.border||"#666";
  const palabras=libro.palabras||[]; let p=palabras.length>0?palabras[Math.floor(Math.random()*palabras.length)]:"";
  const buscalibreHTML = `
  <div style="margin:22px 0;display:flex;flex-direction:column;gap:14px;text-align:center;">
    <a href="https://www.buscalibre.com.mx/libros/search/?q=${encodeURIComponent(libro.titulo + ' ' + libro.autor)}" target="_blank" onclick="event.stopPropagation();" style="padding:12px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:16px;display:flex;align-items:center;justify-content:center;gap:10px;text-decoration:none;background:rgba(255,255,255,0.03);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:all .25s ease;">
      <img src="https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/buscalibre.png" style="height:auto;max-height:22px;max-width:120px;" alt="Buscalibre">
      <span style="font:600 15px 'Archivo',sans-serif;color:#ffffff;letter-spacing:0.25px;">Comprar libro</span>
    </a>
    <a href="https://www.buscalibre.com.mx/libros/search/?q=${encodeURIComponent(p)}" target="_blank" onclick="event.stopPropagation();" style="padding:12px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:16px;text-decoration:none;color:#ffffff;font:600 15px 'Archivo',sans-serif;letter-spacing:0.25px;background:rgba(255,255,255,0.03);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:all .25s ease;">Explora posibilidades</a>
  </div>`;

  card.style = `width:min(420px,90vw);height:min(600px,90vh);background:${safePaper};color:${safeInk};border:2px solid ${safeBorder};border-radius:20px;padding:20px;font-family:${t.style.serif||"Georgia"};display:flex;flex-direction:column;justify-content:space-between;font-size:clamp(18px,2.2vw,26px);line-height:1.45;box-sizing:border-box;box-shadow:0 8px 32px rgba(0,0,0,.45);`;
  card.innerHTML = `
    <div style="font:800 22px ${t.style.serif||"Georgia"};margin-bottom:12px;letter-spacing:0.3px;">${libro.titulo} Â· ${libro.autor}</div>
    <div style="font:18px/1.45 ${t.style.serif||"Georgia"};margin-bottom:14px;opacity:.95;">${t.parrafoTop}</div>
    <div style="font:600 21px ${t.style.sans||"Arial"};color:${t.style.accent||"#30ffe4"};margin:12px 0;">${t.subtitulo}</div>
    <div style="font:18px/1.45 ${t.style.serif||"Georgia"};flex:1;margin-bottom:12px;">${t.parrafoBot}</div>
    ${buscalibreHTML}
    <div style="text-align:center;margin-top:10px;"><img src="${safeInk==='#000'?'https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/trigguiletras2.png':((t.style.accent&&Math.random()>0.5)?'https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/trigguiletrascolor3.png':'https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/trigguiletrasblanco.png')}" alt="Triggui" style="max-width:22%;max-height:40px;height:auto;display:block;margin:0 auto;opacity:.9;"></div>
  `;
  document.getElementById("tarjetaOverlay").style.display="flex";
  track('card_viewed', { book: libro.titulo });
};
document.getElementById("tarjetaOverlay").onclick=()=>{ document.getElementById("tarjetaOverlay").style.display="none"; };

// INIT
function isWebView(){ const ua=navigator.userAgent||navigator.vendor||window.opera; return (/wv/i.test(ua)||/WebView/i.test(ua)||(ua.includes("Android")&&ua.includes("Version/"))||(ua.includes("iPhone")&&!ua.includes("Safari"))); }
if(isWebView()) document.body.classList.add("webview");

function pickLibroNoRepetido(libros){
  let last=sessionStorage.getItem("lastLibroIdx"); if(last!==null)last=parseInt(last);
  let idx=Math.floor(Math.random()*libros.length);
  if(idx===last){ idx=Math.floor(Math.random()*libros.length); if(idx===last)idx=(idx+1)%libros.length; }
  sessionStorage.setItem("lastLibroIdx", idx); return idx;
}

(async()=>{
  try{
    const r=await fetch("https://raw.githubusercontent.com/badirnakid/triggui-content/main/contenido.json?ts="+Date.now());
    const data=await r.json();
    libro=data.libros[pickLibroNoRepetido(data.libros)];
    render(); 
    // Init Visual
    updateBadge();
    track('app_loaded', {streak:getLocal('streak',0), books:getLocal('books_opened',0)});
  }catch(e){ 
    // Fallback silencioso en prod
    console.error(e);
  }
})();
</script>

<script>
  const signalFirstPaint = () => { requestAnimationFrame(() => { try { window.ReactNativeWebView?.postMessage("FIRST_PAINT"); } catch (_) {} }); };
  if (document.readyState === "interactive" || document.readyState === "complete") { signalFirstPaint(); } else { document.addEventListener("DOMContentLoaded", signalFirstPaint, { once: true }); }
</script>

</body>
</html>
