<!DOCTYPE html>
<html lang="es" style="background:#0e0f1b;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
<title>Triggui â€” Abre un libro fÃ­sico. AquÃ­ y ahora.</title>

<style>
  html, body {
    background:#0e0f1b !important;
    color:#fff;
    margin:0;
    padding:0;
    height:100%;
  }
</style>

<meta property="og:title" content="Abre. Un Libro. FÃ­sico.">
<meta property="og:description" content="Toma un libro fÃ­sico que tengas cerca, Ã¡brelo en cualquier parte, lee la primera lÃ­nea que veas.">
<meta property="og:image" content="https://triggui.com/imagotipo.png">
<meta property="og:url" content="https://triggui.com">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Triggui â€“ Abre un libro fÃ­sico. AquÃ­ y ahora.">
<meta name="twitter:description" content="Un impulso real. Nada mÃ¡s. Nada menos.">
<meta name="twitter:image" content="https://triggui.com/imagotipo.png">

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CLK554FCNM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-CLK554FCNM');
</script>

<!-- ========================================
     TRIGGUI ENGAGEMENT FRAMEWORK - NIVEL DIOS
     ======================================== -->
<script>
// ========================================
// STORAGE LOCAL (CERO BACKEND)
// ========================================
function saveLocal(key, value) {
  try {
    localStorage.setItem('triggui_' + key, JSON.stringify(value));
  } catch(e) {}
}

function getLocal(key, defaultValue = null) {
  try {
    const data = localStorage.getItem('triggui_' + key);
    return data ? JSON.parse(data) : defaultValue;
  } catch(e) {
    return defaultValue;
  }
}

// ========================================
// TRACKING ANÃ“NIMO (Solo Analytics)
// ========================================
function track(event, data = {}) {
  if (typeof gtag !== 'undefined') {
    gtag('event', event, {
      event_category: 'app_engagement',
      ...data
    });
  }
  console.log('ðŸ“Š', event, data);
}

// ========================================
// STREAK SYSTEM (ADICCIÃ“N NIVEL DIOS)
// ========================================
function updateStreak() {
  const today = new Date().toDateString();
  const lastVisit = getLocal('last_visit');
  const streak = getLocal('streak', 0);
  
  if (lastVisit === today) {
    return streak; // Ya visitÃ³ hoy
  }
  
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  const newStreak = (lastVisit === yesterday) ? streak + 1 : 1;
  
  saveLocal('streak', newStreak);
  saveLocal('last_visit', today);
  
  track('streak_updated', { streak: newStreak });
  
  return newStreak;
}

// ========================================
// BOOKS COUNTER
// ========================================
function incrementBooks() {
  const count = getLocal('books_opened', 0) + 1;
  saveLocal('books_opened', count);
  saveLocal('last_book_time', Date.now());
  track('book_opened', { total: count });
  return count;
}

// ========================================
// VARIABLE REWARDS (Sorpresas aleatorias)
// ========================================
const surprises = [
  { type: 'rare', msg: 'âœ¨ Libro raro desbloqueado', chance: 0.15 },
  { type: 'streak', msg: 'ðŸ”¥ Racha activa', chance: 0.25 },
  { type: 'milestone', msg: 'ðŸŽ¯ Milestone alcanzado', chance: 0.10 },
  { type: 'none', msg: '', chance: 0.50 }
];

function getRandomSurprise() {
  const rand = Math.random();
  let cumulative = 0;
  
  for (const s of surprises) {
    cumulative += s.chance;
    if (rand <= cumulative) return s;
  }
  
  return surprises[surprises.length - 1];
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;700&family=Poppins:wght@500;800&display=swap" rel="stylesheet">

<style>
:root{
  --btnSize: clamp(4rem, 15vw, 7rem);
}

*{margin:0;padding:0;box-sizing:border-box}
html,body{
  height:100%;
  font-family:'Archivo',sans-serif;
  -webkit-overflow-scrolling:touch;
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

#tarjetaCard {
  overflow-wrap: break-word;
  word-break: break-word;
  box-sizing: border-box;
}

/* Intro */
.intro{
  position:fixed;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  padding:2rem 2.4rem;
  background:rgba(20,24,38,.78);
  border-radius:28px;
  z-index:120;
  font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  text-align:center;
  box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
  letter-spacing:.3px;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  font-size:clamp(1.1rem,3.8vw,1.9rem);
  font-weight:700;
  line-height:1.25;
  opacity:0; 
  transform:translate(-50%,-52%) scale(.985);
  animation:introIn .6s ease-out .15s forwards, introHide 3.2s 1.7s forwards; 
}

.intro .t{
  background:linear-gradient(120deg,#c9fff2,#30ffe4 40%,#9dd5ff);
  -webkit-background-clip:text; 
  background-clip:text;
  -webkit-text-fill-color:transparent; 
  color:#eaf7ff;
  text-shadow:0 0 0 transparent;
}

.intro .s{
  display:block;
  margin-top:.45rem;
  font-weight:600;
  opacity:.85;
  font-size:clamp(.85rem,2.8vw,1.05rem);
  color:#dfe9ff;
}

@media (prefers-reduced-motion: reduce){
  .intro{animation:introHide 0s 2.2s forwards}
}

@keyframes introIn{
  to{opacity:1; transform:translate(-50%,-50%) scale(1)}
}

@keyframes introHide{
  to{opacity:0; visibility:hidden; transform:translate(-50%,-80%) scale(.985)}
}

/* Grid */
.grid{position:absolute;inset:5vh 1.5vw;display:grid;gap:1vw}

@keyframes gridFadeIn {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}

@media(orientation:landscape){.grid{grid-template-columns:repeat(4,1fr)}}
@media(orientation:portrait){.grid{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr)}}

/* Blocks */
.block{
  position:relative;
  display:flex;align-items:center;justify-content:center;
  padding:1rem;border-radius:22px;font-weight:700;cursor:pointer;
  background-size:320% 320%;
  transition:background-position 4s linear, transform .15s ease, filter .2s ease;
  overflow:hidden;isolation:isolate;
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.06),
    0 8px 22px rgba(0,0,0,.28);
  will-change: background-position, transform;
}
.block:hover{ background-position:100% 100%; filter:saturate(1.05) contrast(1.02); }
.block:active{ transform:scale(.97); box-shadow:0 10px 24px rgba(0,0,0,.30); }

.block::before{
  content:"";position:absolute;inset:0;border-radius:inherit;
  background:linear-gradient(180deg,rgba(255,255,255,.14),transparent 62%);
  mix-blend-mode:soft-light;pointer-events:none;
}

.block::after{
  content:"";position:absolute;inset:0;border-radius:inherit;
  box-shadow:0 0 0 1px rgba(0,0,0,.20) inset, 0 0 0 1px rgba(255,255,255,.04);
  pointer-events:none;
}

@media (prefers-reduced-motion: reduce){
  .block{transition:transform .15s ease}
  .block:hover{background-position:0 0;filter:none}
}

/* Labels y frases */
.label {
  z-index:2;
  text-align:center;
  opacity:1;
  transition:opacity .25s, transform .25s;
  transform:translateY(0);
  font-size:clamp(1rem, 3vw, 1.6rem);
  font-weight:700;
  line-height:1.3;
  letter-spacing:0.3px;
}

.frase {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:1rem;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .25s, transform .25s;
  font-size:clamp(0.95rem, 2.8vw, 1.4rem);
  font-weight:600;
  line-height:1.35;
}

.block.show .label {
  opacity:0;
  transform:translateY(-6px);
}

.block.show .frase {
  opacity:1;
  transform:translateY(0);
}

/* Portada */
.portada{
  position:absolute;inset:0;
  display:none;align-items:center;justify-content:center;
  flex-direction:column;padding:1rem;gap:.4rem;text-align:center;
  animation:pop .6s ease-out forwards;
  max-height:90%;overflow:hidden
}

@keyframes pop{
  0%{transform:scale(.8);opacity:0}
  100%{transform:scale(1);opacity:1}
}

.portada img{
  max-width:94%;max-height:76%;
  border-radius:18px;
  box-shadow:0 12px 32px rgba(0,0,0,.55)
}

.port-text h2,.port-text p,.emoji-big{
  animation:settle .6s ease-out forwards;
  opacity:0
}

@keyframes settle{
  0%{transform:scale(1.25);opacity:0}
  100%{transform:scale(1);opacity:1}
}

.port-text h2{
  font-size:clamp(2.8rem,7vw,4rem);
  font-weight:800;line-height:1.15;
  text-shadow:0 2px 6px rgba(0,0,0,.35)
}

.port-text p{
  font-size:clamp(1.5rem,4vw,2.2rem);
  font-weight:600;opacity:.9;margin-top:.3rem
}

.emoji-big{
  font-size:clamp(1.6rem,5vw,2.8rem);
  filter:drop-shadow(0 4px 8px rgba(0,0,0,.3))
}

/* CTA Buttons */
.cta{
  position:fixed;bottom:3vh;left:50%;transform:translateX(-50%);
  z-index:100;display:none;gap:.9rem;justify-content:center;flex-wrap:wrap
}

.cta button{
  width:clamp(3rem,min(7vw,7vh),4rem);
  height:clamp(3rem,min(7vw,7vh),4rem);
  flex:0 0 clamp(3rem,min(7vw,7vh),4rem);
  border:none;border-radius:22px;
  display:flex;align-items:center;justify-content:center;
  font-size:clamp(1.25rem,3.2vw,1.7rem);
  cursor:pointer;background-size:200% 200%;
  transition:transform .2s ease, filter .2s ease, box-shadow .3s ease;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.18),
    0 8px 22px rgba(0,0,0,.28);
  backdrop-filter:blur(8px); 
  -webkit-backdrop-filter:blur(8px);
  outline:0; position:relative; isolation:isolate;
}

.cta button::after{
  content:"";position:absolute;inset:0;border-radius:inherit;
  box-shadow:0 0 0 1px rgba(255,255,255,.08) inset, 0 0 0 1px rgba(0,0,0,.18);
  pointer-events:none;
}

.cta button:hover{ 
  filter:saturate(1.06) contrast(1.04); 
  transform:translateY(-2px) 
}

.cta button:active{ transform:translateY(0); }
.cta button:focus-visible{ box-shadow:0 0 0 3px rgba(48,255,228,.45); }
.cta .icon{font-size:1.55rem;line-height:1;}

#otro{ background:linear-gradient(135deg,#5fbfff,#1e90ff); color:#0b1820 }
#fisico{ background:linear-gradient(135deg,#b2f8c8,#42d97c); color:#0c2d1b }
#share{ background:linear-gradient(135deg,#ff8a00,#ff3d3d); color:#1b0b0b }

/* CelebraciÃ³n */
.cele{
  position:fixed;inset:0;
  background:rgba(0,0,0,.88);
  display:none;align-items:center;justify-content:center;
  z-index:110
}

.cele-msg{
  font-family:'Poppins';
  font-size:2rem;text-align:center;
  background:rgba(255,255,255,.05);
  padding:2rem 3rem;border-radius:20px
}

.num{
  color:#30ffe4;font-weight:900;font-size:2.8rem
}

/* Tarjeta Overlay */
#tarjetaOverlay {
  display:none;
  position:fixed;
  inset:0;
  z-index:999;
  align-items:center;
  justify-content:center;
  background: radial-gradient(
    circle at center,
    rgba(0,0,0,0.85) 0%,
    rgba(0,0,0,0.92) 100%
  );
}

#tarjetaCard {
  width: min(420px, 90vw);
  height: 600px;
  font-size: clamp(16px, 2.6vw, 22px);
  line-height: 1.35;
  -webkit-text-size-adjust: none;
  text-size-adjust: none;
  opacity: 0;
  transform: scale(0.92);
  animation: cardIn 0.45s ease-out forwards;
  border-radius: 20px;
}

body.webview #tarjetaCard {
  height: 650px !important;
  font-size: clamp(16px, 2.4vw, 20px);
}

@media (orientation: landscape) {
  #tarjetaCard {
    height: min(560px, 85vh);
  }

  body.webview #tarjetaCard {
    height: min(650px, 85vh) !important;
  }
}

@keyframes cardIn {
  from { opacity:0; transform:scale(0.92); }
  to   { opacity:1; transform:scale(1); }
}

#tarjetaCard img {
  max-width: 25%;
  max-height: 38px;
  height: auto;
  display: block;
  margin: 0 auto;
  opacity: .9;
}

body.webview {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #0e0f1b;
}

/* Pulse Portada */
@keyframes trigguiPulse {
  0% {
    transform: scale(1);
    filter: drop-shadow(0 0 0px rgba(255,255,255,0));
  }
  50% {
    transform: scale(1.099);
    filter: drop-shadow(0 0 16px rgba(255,255,255,0.12));
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 0px rgba(255,255,255,0));
  }
}

.portada.reveal-pulse img {
  animation: trigguiPulse 2.8s cubic-bezier(0.32, 0.01, 0.16, 1) infinite;
  will-change: transform, filter;
}

/* ========================================
   NUEVOS ESTILOS - ENGAGEMENT BADGES
   ======================================== */

/* Streak Badge (top-left, hermoso) */
#streakBadge {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 90;
  background: rgba(255,110,196,0.15);
  border: 1px solid rgba(255,110,196,0.3);
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 14px;
  color: #ff6ec4;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  font-weight: 700;
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeInDown 0.5s ease 0.5s forwards;
  box-shadow: 0 4px 12px rgba(255,110,196,0.2);
}

/* Books Counter Badge (top-right, hermoso) */
#booksBadge {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 90;
  background: rgba(48,255,228,0.15);
  border: 1px solid rgba(48,255,228,0.3);
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 14px;
  color: #30ffe4;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  font-weight: 700;
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeInDown 0.5s ease 0.7s forwards;
  box-shadow: 0 4px 12px rgba(48,255,228,0.2);
}

@keyframes fadeInDown {
  from { 
    opacity: 0; 
    transform: translateY(-10px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

/* Toast Notification (center-top) */
#toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  z-index: 110;
  background: rgba(20,24,38,0.95);
  border: 1px solid rgba(255,255,255,0.1);
  padding: 14px 24px;
  border-radius: 16px;
  font-size: 15px;
  color: #fff;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  font-weight: 600;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  text-align: center;
  max-width: 80%;
}

#toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* Mobile adjustments */
@media (max-width: 480px) {
  #streakBadge, #booksBadge {
    font-size: 12px;
    padding: 6px 10px;
    top: 15px;
  }
  
  #streakBadge {
    left: 15px;
  }
  
  #booksBadge {
    right: 15px;
  }
  
  #toast {
    font-size: 13px;
    padding: 10px 16px;
    top: 70px;
  }
}
</style>
</head>
<body style="background:#0e0f1b; margin:0; padding:0; height:100%; color:#fff;">

<!-- ========================================
     ENGAGEMENT BADGES - NIVEL DIOS
     ======================================== -->

<!-- Streak Badge -->
<div id="streakBadge">ðŸ”¥ 0 dÃ­as</div>

<!-- Books Counter Badge -->
<div id="booksBadge">ðŸ“š 0 libros</div>

<!-- Toast Notification -->
<div id="toast"></div>

<!-- Intro -->
<div class="intro" id="intro"></div>

<!-- Grid -->
<div class="grid" id="grid"></div>

<!-- CTA Buttons -->
<div class="cta" id="cta">
  <button id="otro">
    <span class="icon">ðŸŽ²</span>
  </button>
  <button id="fisico">
    <span class="icon">ðŸ”Ÿ</span>
  </button>
  <button id="share">
    <span class="icon">ðŸ“–</span>
  </button>
</div>

<!-- Tarjeta Overlay -->
<div id="tarjetaOverlay">
  <div id="tarjetaCard"></div>
</div>

<!-- CelebraciÃ³n -->
<div class="cele" id="cele">
  <div class="cele-msg" id="celeMsg">
    âœ¨ <span class="num">...</span><br>libros fÃ­sicos abiertos
  </div>
</div>

<script>
// ========================================
// VARIABLES GLOBALES
// ========================================
const grid=document.getElementById("grid"),
      cta=document.getElementById("cta"),
      btnOtro=document.getElementById("otro"),
      btnLibro=document.getElementById("fisico"),
      btnShare=document.getElementById("share"),
      cele=document.getElementById("cele"),
      celeMsg=document.getElementById("celeMsg"),
      streakBadge=document.getElementById("streakBadge"),
      booksBadge=document.getElementById("booksBadge"),
      toast=document.getElementById("toast");

let libro=null, revealed=false;
const portIdx=Math.floor(Math.random()*4),
      emojis=["ðŸŒŠ","ðŸ›¡ï¸","ðŸ§ ","âœ¨","ðŸ“˜","ðŸ”®","â¤ï¸","ðŸªž"],
      isURL = s => /^https?:\/\//i.test(s || "");
const ANG = [115,205,35,320];
const grad = i => `linear-gradient(${ANG[i%4]}deg,${libro.colores[i]},${libro.colores[(i+1)%4]})`;

// ========================================
// TOAST NOTIFICATION SYSTEM
// ========================================
function showToast(message, duration = 3000) {
  toast.textContent = message;
  toast.classList.add('visible');
  
  setTimeout(() => {
    toast.classList.remove('visible');
  }, duration);
}

// ========================================
// UPDATE BADGES
// ========================================
function updateBadges() {
  const streak = getLocal('streak', 0);
  const books = getLocal('books_opened', 0);
  
  streakBadge.textContent = `ðŸ”¥ ${streak} dÃ­a${streak !== 1 ? 's' : ''}`;
  booksBadge.textContent = `ðŸ“š ${books} libro${books !== 1 ? 's' : ''}`;
}

// ========================================
// INTRO MESSAGES
// ========================================
const frasesIntro = [
  "Â¿QuÃ© sientes y quÃ© buscas ahora?",
  "Â¿QuÃ© sientes y quÃ© buscas ahora?",
  "Â¿QuÃ© sientes y quÃ© buscas ahora?"
];
const introEl=document.getElementById("intro");
const frase=frasesIntro[Math.floor(Math.random()*frasesIntro.length)];
introEl.innerHTML=`<span class="t">${frase}</span>`;

// ========================================
// PORTADA BUILDER
// ========================================
function adjustScale(wrap){
  const parent=wrap.closest(".portada");
  if(!parent)return;
  const avail=parent.clientHeight-40;
  let scale=1;
  wrap.style.transform="scale(1)";
  while(wrap.scrollHeight>avail&&scale>0.55){
    scale-=.02;
    wrap.style.transform=`scale(${scale})`;
  }
}

function buildPort(i){
  const d=document.createElement("div");
  d.className="portada";
  const wrap=document.createElement("div");
  wrap.className="port-text-wrap";
  const box=document.createElement("div");
  box.className="port-text";
  box.innerHTML=`<h2>${libro.titulo}</h2><p>${libro.autor}</p>`;
  const emoji=document.createElement("div");
  emoji.className="emoji-big";
  emoji.textContent=emojis[i%emojis.length];
  wrap.append(box,emoji);
  
  if(isURL(libro.portada)){
    d.append(Object.assign(new Image(),{src:libro.portada,loading:"lazy"}));
  }else{
    d.append(wrap);
    setTimeout(()=>adjustScale(wrap),0);
  }

  d.addEventListener("click", e => {
    e.stopPropagation();
    btnShare.click();
  });

  return d;
}

// ========================================
// RENDER GRID
// ========================================
function render(){
  grid.innerHTML="";
  
  for(let i=0;i<4;i++){
    const card=document.createElement("div");
    card.className="block";
    card.style.background=grad(i);

    const label=document.createElement("div");
    label.className="label";
    label.textContent=`${emojis[i%emojis.length]} ${libro.palabras[i]}`;
    label.style.color=libro.textColors?.[i]||"#fff";

    const frase=document.createElement("div");
    frase.className="frase";
    frase.textContent=libro.frases[i];
    frase.style.color=libro.textColors?.[i]||"#fff";

    const port=buildPort(i);

    if(i===portIdx){
      card.append(port);
      card.append(label,frase);

      card.addEventListener("click", e=>{
        if(!revealed){
          // Primera revelaciÃ³n
          label.style.display="none";
          port.style.display="flex";
          port.classList.add("reveal-pulse");
          
          [...grid.children].forEach((c,j)=>j!==portIdx&&c.classList.add("show"));
          cta.style.display="flex";
          revealed=true;

          // Actualizar colores CTA
          const c = libro.colores;
          document.getElementById("otro").style.background = `linear-gradient(135deg, ${c[0]}, ${c[1]})`;
          document.getElementById("fisico").style.background = `linear-gradient(135deg, ${c[1]}, ${c[2]})`;
          document.getElementById("share").style.background = `linear-gradient(135deg, ${c[2]}, ${c[3]})`;
          document.getElementById("otro").style.color = pickTextColor(c[0]);
          document.getElementById("fisico").style.color = pickTextColor(c[1]);
          document.getElementById("share").style.color = pickTextColor(c[2]);

          // âœ¨ ENGAGEMENT MAGIC âœ¨
          handleBookReveal();
          
        }else{
          e.stopPropagation();
          btnShare.click();
        }
      });
    } else {
      card.append(label,frase);
      card.onclick=()=>handle(card,i,port,label);
    }

    grid.append(card);
  }
}

// ========================================
// HANDLE CARD CLICK
// ========================================
function handle(card,i,port,label){
  if(revealed){
    location.reload();
    return;
  }
  if(i===portIdx){
    label.style.display="none";
    port.style.display="flex";
    [...grid.children].forEach((c,j)=>j!==portIdx&&c.classList.add("show"));
    cta.style.display="flex";
    revealed=true;
  }else{
    card.classList.toggle("show");
  }
}

// ========================================
// âœ¨ ENGAGEMENT MAGIC - NIVEL DIOS âœ¨
// ========================================
function handleBookReveal() {
  // Increment counters
  const streak = updateStreak();
  const booksCount = incrementBooks();
  
  // Update badges
  updateBadges();
  
  // Track to Analytics
  fetch("https://triggui-api.vercel.app/api/increment", {
    cache: "no-store"
  }).catch(()=>{});
  
  // Variable Reward System
  const surprise = getRandomSurprise();
  
  // Streak milestones
  if (streak === 3) {
    showToast('ðŸ”¥ 3 dÃ­as seguidos!');
  } else if (streak === 7) {
    showToast('ðŸ”¥ðŸ”¥ Una semana completa!');
  } else if (streak === 30) {
    showToast('ðŸ”¥ðŸ”¥ðŸ”¥ UN MES! Eres imparable');
  }
  
  // Books milestones + Upgrade Prompts
  if (booksCount === 7) {
    setTimeout(() => {
      if (confirm('ðŸ“š Has descubierto 7 libros!\n\nÂ¿Quieres recibirlos por WhatsApp cada lunes?\n(Primera semana gratis)')) {
        window.open('https://triggui.com/#planes', '_blank');
        track('upgrade_prompt_7books_accepted');
      } else {
        track('upgrade_prompt_7books_declined');
      }
    }, 2000);
  } else if (booksCount === 15) {
    setTimeout(() => {
      showToast('ðŸ“¬ Recibe estos libros por email gratis');
      setTimeout(() => {
        const email = prompt('Tu email para recordatorios semanales:');
        if (email && email.includes('@')) {
          // AquÃ­ se conectarÃ­a con tu Google Sheet
          track('email_captured', { source: 'app_15books' });
          showToast('âœ… Listo! RecibirÃ¡s recordatorios cada lunes');
        }
      }, 3000);
    }, 2000);
  } else if (booksCount === 30) {
    setTimeout(() => {
      if (confirm('ðŸŽ¯ 30 libros descubiertos!\n\nDesbloquea acceso lifetime por $3,999')) {
        window.open('https://donate.stripe.com/9B66oJ8bI1E02U85aR24001', '_blank');
        track('upgrade_prompt_30books_lifetime');
      }
    }, 2000);
  }
  
  // Random surprises
  if (surprise.type !== 'none') {
    setTimeout(() => {
      showToast(surprise.msg);
      track('surprise_shown', { type: surprise.type });
    }, 1000);
  }
}

// ========================================
// BUTTON HANDLERS
// ========================================
btnOtro.onclick = () => {
  location.reload();
  track('reload_clicked');
};

btnLibro.onclick = async() => {
  btnLibro.disabled=true;
  cele.style.display="flex";
  celeMsg.innerHTML='âœ¨ <span class="num">...</span><br>libros que hemos abierto juntos';
  
  try{
    const r=await fetch("https://triggui-api.vercel.app/api/increment");
    const d=await r.json();
    celeMsg.innerHTML=`âœ¨ <span class="num">${d.total.toLocaleString("es-MX")}</span><br>libros que hemos abierto juntos`;
    track('physical_book_opened', { total: d.total });
  }catch{
    celeMsg.textContent="ðŸ“š Error al contar libros";
  }
  
  setTimeout(()=>{
    cele.style.display="none";
    btnLibro.disabled=false;
  },2300);
};

// ========================================
// CONTRAST HELPER
// ========================================
function luminance(hex) {
  try {
    const c = hex.replace("#","").match(/.{1,2}/g).map(x=>parseInt(x,16)/255);
    const f = v => v<=.03928 ? v/12.92 : Math.pow((v+.055)/1.055,2.4);
    return 0.2126*f(c[0])+0.7152*f(c[1])+0.0722*f(c[2]);
  } catch {
    return 0;
  }
}

function pickTextColor(bg) {
  try { 
    return luminance(bg) > 0.35 ? "#000" : "#fff"; 
  } catch { 
    return "#fff"; 
  }
}

// ========================================
// TARJETA SHARE
// ========================================
btnShare.onclick = () => {
  const t = libro.tarjeta;
  const card = document.getElementById("tarjetaCard");

  const safePaper  = t.style.paper  || "#111111";
  const safeInk    = t.style.ink    || pickTextColor(safePaper);
  const safeBorder = t.style.border || "#666";
  const safeSerif  = t.style.serif  || "Georgia, serif";
  const safeSans   = t.style.sans   || "Arial, sans-serif";

  const activarBuscalibre = true;
  let buscalibreHTML = "";

  if (activarBuscalibre) {
    const palabras = libro.palabras || [];
    let p = "";
    if (palabras.length > 0) {
      p = palabras[Math.floor(Math.random() * palabras.length)] || "";
    }
    const queryRandom = encodeURIComponent(p);

    buscalibreHTML = `
  <div style="
    margin: 22px 0;
    display: flex;
    flex-direction: column;
    gap: 14px;
    text-align: center;
  ">
    <a 
      href="https://www.buscalibre.com.mx/libros/search/?q=${encodeURIComponent(libro.titulo + ' ' + libro.autor)}"
      target="_blank"
      onclick="event.stopPropagation();"
      style="
        padding: 12px 16px;
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
        background: rgba(255,255,255,0.03);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        transition: all .25s ease;
      "
      onmouseover="this.style.borderColor='rgba(255,255,255,0.35)'"
      onmouseout="this.style.borderColor='rgba(255,255,255,0.15)'"
    >
      <img 
        src="https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/buscalibre.png"
        alt="Buscalibre"
        style="
          display:block;
          height:auto;
          max-height:22px;
          max-width:120px;
          width:auto;
          object-fit:contain;
          object-position:center;
          opacity:0.90;
        "
      >
      <span style="
        font: 600 15px 'Archivo', sans-serif;
        color:#ffffff;
        letter-spacing: 0.25px;
      ">
        Comprar libro
      </span>
    </a>

    <a 
      href="https://www.buscalibre.com.mx/libros/search/?q=${queryRandom}"
      target="_blank"
      onclick="event.stopPropagation();"
      style="
        padding: 12px 16px;
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 16px;
        text-decoration: none;
        color:#ffffff;
        font: 600 15px 'Archivo', sans-serif;
        letter-spacing: 0.25px;
        background: rgba(255,255,255,0.03);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        transition: all .25s ease;
      "
      onmouseover="this.style.borderColor='rgba(255,255,255,0.35)'"
      onmouseout="this.style.borderColor='rgba(255,255,255,0.15)'"
    >
      Explora posibilidades
    </a>
  </div>
`;
  }

  card.style = `
    width: min(420px, 90vw);
    height: min(600px, 90vh);
    background:${safePaper};
    color:${pickTextColor(safePaper)};
    border:2px solid ${safeBorder};
    border-radius:20px;
    padding:20px;
    font-family:${safeSerif};
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    font-size:clamp(18px, 2.2vw, 26px);
    line-height:1.45;
    box-sizing:border-box;
    box-shadow:0 8px 32px rgba(0,0,0,.45);
  `;

  card.innerHTML = `
    <div style="font:800 22px ${safeSerif};margin-bottom:12px;letter-spacing:0.3px;">
      ${libro.titulo} Â· ${libro.autor}
    </div>
    <div style="font:18px/1.45 ${safeSerif};margin-bottom:14px;opacity:.95;">
      ${t.parrafoTop}
    </div>
    <div style="font:600 21px ${safeSans};color:${t.style.accent || "#30ffe4"};margin:12px 0;">
      ${t.subtitulo}
    </div>
    <div style="font:18px/1.45 ${safeSerif};flex:1;margin-bottom:12px;">
      ${t.parrafoBot}
    </div>

${buscalibreHTML}
    
    <div style="text-align:center; margin-top:10px;">
      <img src="${
        pickTextColor(safePaper) === '#000'
          ? 'https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/trigguiletras2.png'
          : (
              (t.style.accent && Math.random() > 0.5)
                ? 'https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/trigguiletrascolor3.png'
                : 'https://raw.githubusercontent.com/badirnakid/triggui-app/main/public/trigguiletrasblanco.png'
            )
      }"
      alt="Triggui"
      style="max-width:22%; max-height:40px; height:auto; display:block; margin:0 auto; opacity:.9;">
    </div>
  `;

  document.getElementById("tarjetaOverlay").style.display = "flex";
  track('card_viewed', { book: libro.titulo });
};

// Cerrar overlay
document.getElementById("tarjetaOverlay").onclick = () => {
  document.getElementById("tarjetaOverlay").style.display = "none";
};

// ========================================
// WEBVIEW DETECTION
// ========================================
function isWebView() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  return (/wv/i.test(ua) || /WebView/i.test(ua) ||
          (ua.includes("Android") && ua.includes("Version/")) ||
          (ua.includes("iPhone") && !ua.includes("Safari")));
}
if (isWebView()) {
  document.body.classList.add("webview");
}

// ========================================
// ANTI-REPETICIÃ“N
// ========================================
function pickLibroNoRepetido(libros) {
  let last = sessionStorage.getItem("lastLibroIdx");
  if (last !== null) last = parseInt(last);

  let idx = Math.floor(Math.random() * libros.length);

  if (idx === last) {
    idx = Math.floor(Math.random() * libros.length);
    if (idx === last) idx = (idx + 1) % libros.length;
  }

  sessionStorage.setItem("lastLibroIdx", idx);
  return idx;
}

// ========================================
// INIT APP
// ========================================
(async()=>{
  try{
    const r = await fetch("https://raw.githubusercontent.com/badirnakid/triggui-content/main/contenido.json?ts=" + Date.now());
    const data = await r.json();

    libro = data.libros[pickLibroNoRepetido(data.libros)];
    render();
    updateBadges();
    
    track('app_loaded', { 
      streak: getLocal('streak', 0),
      books: getLocal('books_opened', 0)
    });
    
  }catch(e){
    alert("No se pudo cargar Triggui.");
    console.error(e);
  }
})();
</script>

<!-- REACT NATIVE BRIDGE -->
<script>
  const signalFirstPaint = () => {
    requestAnimationFrame(() => {
      try {
        window.ReactNativeWebView?.postMessage("FIRST_PAINT");
      } catch (_) {}
    });
  };

  if (document.readyState === "interactive" || document.readyState === "complete") {
    signalFirstPaint();
  } else {
    document.addEventListener("DOMContentLoaded", signalFirstPaint, { once: true });
  }
</script>

</body>
</html>
